[filename, folder] = uigetfile({'*.csv', 'CSV file (*.csv)'}, 'Choose a Trial 1 file');maxTrials = 3; % maximum possible is currently 9plottingYes = 1; % 0 = no, 1 = yesshowFigures = 1; % 0 = no, 1 = yes if filename == 0  disp('No file selected.')  returnendfn_length = length(filename);filename_stub = filename(1:fn_length-7);all_data = NaN(5000, maxTrials+1); %make a big empty matrix to store the datamaxRows = 1;metadata = NaN(6, maxTrials+1);%% Metadata matrix has 6 rows  and 1 column for time + 1 per trial:% 1) # of datapoints, % 2) time at last datapoint,% 3) minimum value per column,% 4) row of min value,% 5) max value per column,% 6) row of max value.for nTrial = 1:maxTrials  fn = strcat(folder, filename_stub, '-0', num2str(nTrial),'.csv');  trial_data = importdata(fn, ",", 1);  [numRows, numCols] = size(trial_data.data);  if numCols > 2  %This script assumes only one trial per data file, so error out if there's more than that.    disp(fn)    error('Data file contains more than one trial.')  end  if numRows > maxRows    maxRows = numRows;    all_data(1:numRows, 1) = trial_data.data(:,1);  end    all_data(1:numRows, nTrial+1) = trial_data.data(:,2);    metadata(1, nTrial+1) = numRows;    metadata(2, nTrial+1) = trial_data.data(numRows,1);end[min_vals, min_pos] = min(all_data);[max_vals, max_pos] = max(all_data);metadata(3:6, :) = [min_vals; min_pos; max_vals; max_pos];all_data(max_pos(1)+1:end,:) = []; %Trim off unnecessary NaNs%% Trim the data before the drop/spike in pHdifferences = abs(all_data(1:end-1, :)-all_data(2:end, :));[maxDiff, maxDiffPos] = max(differences);trimmedData = NaN(maxRows, maxTrials+1);trimmedData(:,1) = all_data(:,1);numRowsCopied = maxRows - maxDiffPos;for iTrial = 1:maxTrials  trimmedData(1:numRowsCopied(iTrial+1), iTrial+1) = all_data(maxDiffPos(iTrial+1)+1:end, iTrial+1);endtrimRow = max(numRowsCopied(2:end))+1;trimmedData(trimRow:end,:) = []; %Trim off unnecessary NaNs%[min_vals_trim, min_pos_trim] = min(trimmedData);%[max_vals_trim, max_pos_trim] = max(trimmedData);%trimMetadata = [min_vals; min_pos_trim; max_vals_trim; max_pos_trim];if plottingYes == 1  %% pH plot  fig1 = figure;  plot(all_data(:,1), all_data(:,2:maxTrials+1))  title(strrep(filename_stub, '_','/'))  legend ('trial 1', 'trial 2', 'trial 3')  xlabel('time (s)'); ylabel('pH')  set(gca, 'XLim', [0 100])%  set(gca, 'YLim', [2 9])  hold on  plot([0 100], [7 7],'k-')  hold off  %% Zero order plot  H_conc = NaN(trimRow-1, maxTrials+1); %make a big empty matrix to store the data  H_conc(:, 1) = trimmedData(:, 1);  H_conc(:, 2:maxTrials+1) = [10.^-trimmedData(:,2:maxTrials+1)];  fig2=figure;  plot(H_conc(:,1), H_conc(:, 2:maxTrials+1))  title('Zero order')  legend ('trial 1', 'trial 2', 'trial 3')  xlabel('time (s)'); ylabel('[H^+] (M)')  set(gca,'XLim', [0 100])%   set(gca, 'YLim', [0 0.01])  %% First order plot  lnH = NaN(trimRow-1, maxTrials+1); %make a big empty matrix to store the data  lnH(:, 1) = trimmedData(:, 1);  lnH(:, 2:maxTrials+1) = [log(H_conc(:, 2:maxTrials+1))];  fig3=figure;  plot(lnH(:,1), lnH(:, 2:maxTrials+1))  title('First order')  legend ('trial 1', 'trial 2', 'trial 3')  xlabel('time (s)'); ylabel('ln [H^+]')  set(gca,'XLim', [0 100])%  set(gca, 'YLim', [-20 0])  %% Second order plot  inv_H = NaN(trimRow-1, maxTrials+1); %make a big empty matrix to store the data  inv_H(:, 1) = trimmedData(:, 1);  inv_H(:, 2:maxTrials+1) = [1./H_conc(:, 2:maxTrials+1)];  fig4=figure;  plot(inv_H(:,1), inv_H(:, 2:maxTrials+1))  title('Second order')  legend ('trial 1', 'trial 2', 'trial 3')  xlabel('time (s)'); ylabel('1/[H^+]')  set(gca,'XLim', [0 100])%  set(gca, 'YLim', [1e2 1e9])  %% combined figure  fig5 = figure;  subplot(3,1,1)  p1 = plot(H_conc(:,1), H_conc(:, 2:maxTrials+1));  title('Zero order')  legend ('trial 1', 'trial 2', 'trial 3')  ylabel('[H^+] (M)')  set(gca,'XLim', [0 100])%  set(gca, 'YLim', [0 0.01])  subplot(3,1,2)  p2 = plot(lnH(:,1),lnH(:, 2:maxTrials+1));  title('First order')  ylabel('ln [H^+]')  set(gca,'XLim', [0 100])%  set(gca, 'YLim', [-20 0])    subplot(3,1,3)  p3=plot(inv_H(:,1), inv_H(:, 2:maxTrials+1));  title('Second order')  xlabel('time (s)'); ylabel('1/[H^+]')  set(gca,'XLim', [0 100]) %  set(gca, 'YLim', [1e2 1e9])  combined_order_data = [H_conc lnH(:,2:maxTrials+1) inv_H(:,2:maxTrials+1)];end%% Save output%output_folder = uigetdir;output_folder = '/Users/research/Documents/Bath Bombs/Results';if plottingYes == 1  % Save Figures  saveas(fig1, [output_folder filesep filename_stub '-pH'],'jpg');  saveas(fig2, [output_folder filesep filename_stub '-0-order'],'jpg');  saveas(fig3, [output_folder filesep filename_stub '-1-order'],'jpg');  saveas(fig4, [output_folder filesep filename_stub '-2-order'],'jpg');  saveas(fig5, [output_folder filesep filename_stub '-012-order'],'jpg');end% Save Raw Datadelim = ',';headers = cell(1,maxTrials+1);headers{1} = 'Time (s)';for numTrial = 1:maxTrials  headers{numTrial+1} = sprintf('Trial %d pH', numTrial);endoutPathRaw = [output_folder filesep filename_stub '-data.csv'];output = fopen(outPathRaw, 'wt');fprintf(output, ['%s' repmat([delim '%s'], 1, maxTrials) '\n'], headers{:});fprintf(output, ['%.2f' repmat([delim '%g'], 1, maxTrials) '\n'], all_data');% Save Trimmed DataoutPathTrim = [output_folder filesep filename_stub '-trimmed.csv'];outputTrim = fopen(outPathTrim, 'wt');fprintf(outputTrim, ['%s' repmat([delim '%s'], 1, maxTrials) '\n'], headers{:});fprintf(outputTrim, ['%.2f' repmat([delim '%g'], 1, maxTrials) '\n'], trimmedData');% Save Combined Order Data (rate data for 0, 1, 2 orders)outPathRate = [output_folder filesep filename_stub '-012-order.csv'];outputRate = fopen(outPathRate, 'wt');% first row of headersheaderOrder = cell(1,3*maxTrials+1);headerOrder{2} = '0 Order [H+]';headerOrder{maxTrials+2} = '1 Order ln[H+]';headerOrder{2*maxTrials+2} = '2 Order 1/[H+]';% second row of headersheaderRate = cell(1,3*maxTrials+1);headerRate{1} = 'Time (s)';for iOrder = 0:2  for nTrial = 1:maxTrials    headerRate{1+iOrder*maxTrials+nTrial} = sprintf('Trial %d', nTrial);  endendfprintf(outputRate, ['%s' repmat([delim '%s'], 1, 3*maxTrials) '\n'], headerOrder{:});fprintf(outputRate, ['%s' repmat([delim '%s'], 1, 3*maxTrials) '\n'], headerRate{:});fprintf(outputRate, ['%.2f' repmat([delim '%g'], 1, 3*maxTrials) '\n'], combined_order_data');fclose all;if showFigures == 0close all;end%% To Do: Save data for 0,1,2 order plots to csv file(s)